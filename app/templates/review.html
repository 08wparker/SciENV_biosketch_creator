{% extends "base.html" %}

{% block title %}Review Biosketch - SciENcv Creator{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Review Parsed Biosketch</h1>
            <a href="{{ url_for('main.index') }}"
               class="text-maroon-700 hover:text-maroon-800 text-sm">
                &larr; Upload Another
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="text-sm text-gray-500">Name</label>
                <p class="font-medium text-gray-800">{{ data.name }}</p>
            </div>
            <div>
                <label class="text-sm text-gray-500">eRA Commons Username</label>
                <p class="font-medium text-gray-800">{{ data.era_commons_username }}</p>
            </div>
            <div>
                <label class="text-sm text-gray-500">Position Title</label>
                <p class="font-medium text-gray-800 text-sm">{{ data.position_title }}</p>
            </div>
        </div>
    </div>

    <!-- Education Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <span class="bg-blue-100 text-maroon-800 px-2 py-1 rounded text-sm mr-2">A</span>
            Professional Preparation ({{ data.education|length }} entries)
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-gray-600">Institution</th>
                        <th class="px-4 py-2 text-left text-gray-600">Degree</th>
                        <th class="px-4 py-2 text-left text-gray-600">Date</th>
                        <th class="px-4 py-2 text-left text-gray-600">Field of Study</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for edu in data.education %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">{{ edu.institution }}</td>
                        <td class="px-4 py-2">{{ edu.degree }}</td>
                        <td class="px-4 py-2">{{ edu.completion_date }}</td>
                        <td class="px-4 py-2">{{ edu.field_of_study }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Positions and Honors Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Positions -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm mr-2">B</span>
                Appointments & Positions ({{ data.positions|length }})
            </h2>
            <ul class="space-y-2 text-sm">
                {% for pos in data.positions %}
                <li class="border-l-2 border-purple-200 pl-3">
                    <span class="text-gray-500">{{ pos.dates }}</span>
                    <p class="text-gray-800">{{ pos.title }}</p>
                    {% if pos.institution %}
                    <p class="text-gray-600 text-xs">{{ pos.institution }}</p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Honors -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm mr-2">B</span>
                Honors ({{ data.honors|length }})
            </h2>
            <ul class="space-y-2 text-sm">
                {% for honor in data.honors %}
                <li class="border-l-2 border-yellow-200 pl-3">
                    <span class="text-gray-500">{{ honor.year }}</span>
                    <p class="text-gray-800">{{ honor.description[:100] }}{% if honor.description|length > 100 %}...{% endif %}</p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Products Section - Two Categories -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <span class="bg-teal-100 text-teal-800 px-2 py-1 rounded text-sm mr-2">C</span>
            Products
        </h2>

        <div class="mb-4 p-3 bg-teal-50 border border-teal-200 rounded-lg text-sm text-teal-800">
            <strong>Instructions:</strong> Select products from your publications below. You need two sets:
            <ul class="list-disc list-inside mt-1 ml-2">
                <li><strong>Products closely related to the proposed project</strong> (up to 5)</li>
                <li><strong>Other significant products</strong> highlighting your contributions to science (up to 5)</li>
            </ul>
            Citations are pulled from your personal statement and all contributions.
        </div>

        <!-- Products Closely Related to Proposed Project -->
        <div class="mb-6">
            <h3 class="font-medium text-gray-800 mb-2 flex items-center">
                Products Closely Related to the Proposed Project
                <span class="ml-2 text-sm font-normal text-gray-500">
                    (<span id="related-products-count">0</span>/5 selected)
                </span>
            </h3>
            <div id="related-products-list" class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-2">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Other Significant Products -->
        <div>
            <h3 class="font-medium text-gray-800 mb-2 flex items-center">
                Other Significant Products Highlighting Contributions to Science
                <span class="ml-2 text-sm font-normal text-gray-500">
                    (<span id="other-products-count">0</span>/5 selected)
                </span>
            </h3>
            <div id="other-products-list" class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-2">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Personal Statement Section -->
    {% if data.personal_statement %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm mr-2">Supplement A</span>
                Personal Statement
            </h2>
            <button onclick="editPersonalStatement()" id="edit-ps-btn" class="text-maroon-600 hover:text-maroon-700 text-sm">Edit</button>
        </div>

        <!-- Display Mode -->
        <div id="ps-display" class="prose max-w-none">
            <p class="text-gray-700 mb-4 whitespace-pre-wrap">{{ data.personal_statement.text }}</p>

            {% if data.personal_statement.grants %}
            <div class="mt-4">
                <h3 class="font-medium text-gray-800 mb-2">Research Support ({{ data.personal_statement.grants|length }})</h3>
                <div class="space-y-3">
                    {% for grant in data.personal_statement.grants %}
                    <div class="text-sm border-l-2 border-green-200 pl-3">
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-gray-700">
                            <span class="font-medium">{{ grant.funder }} {{ grant.number }}</span>
                            <span>{{ grant.pi }} ({{ grant.role }})</span>
                            <span class="text-gray-500">{{ grant.dates }}</span>
                        </div>
                        <p class="text-gray-600 mt-1">{{ grant.title }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Edit Mode -->
        <div id="ps-edit" class="hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Personal Statement Text</label>
                <textarea id="ps-text-input"
                          class="w-full p-3 text-sm border rounded-lg focus:ring-2 focus:ring-green-300 focus:border-green-300"
                          rows="8">{{ data.personal_statement.text }}</textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Research Support / Grants</label>
                <div id="grants-editor" class="space-y-3">
                    {% for grant in data.personal_statement.grants %}
                    <div class="grant-row border rounded-lg p-3 bg-gray-50" data-index="{{ loop.index0 }}">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                            <input type="text" placeholder="Funder (e.g., NIH)" value="{{ grant.funder }}"
                                   class="grant-funder px-2 py-1 text-sm border rounded">
                            <input type="text" placeholder="Number" value="{{ grant.number }}"
                                   class="grant-number px-2 py-1 text-sm border rounded">
                            <input type="text" placeholder="PI" value="{{ grant.pi }}"
                                   class="grant-pi px-2 py-1 text-sm border rounded">
                            <input type="text" placeholder="Role (PI, Co-I)" value="{{ grant.role }}"
                                   class="grant-role px-2 py-1 text-sm border rounded">
                            <input type="text" placeholder="Dates" value="{{ grant.dates }}"
                                   class="grant-dates px-2 py-1 text-sm border rounded">
                            <button onclick="removeGrant(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                        </div>
                        <input type="text" placeholder="Grant Title" value="{{ grant.title }}"
                               class="grant-title w-full px-2 py-1 text-sm border rounded">
                    </div>
                    {% endfor %}
                </div>
                <button onclick="addGrant()" class="mt-2 px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                    + Add Grant
                </button>
            </div>

            <div class="flex gap-2">
                <button onclick="savePersonalStatement()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Save</button>
                <button onclick="cancelPersonalStatementEdit()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contributions to Science Section - Interactive -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm mr-2">Supplement C</span>
                Contributions to Science
                <span class="ml-2 text-sm font-normal text-gray-500">
                    (<span id="selected-count">0</span>/5 selected)
                </span>
            </h2>
            <div class="flex gap-2">
                <button onclick="mergeSelected()"
                        class="px-3 py-1 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200 transition-colors"
                        id="merge-btn" disabled>
                    Merge Selected
                </button>
            </div>
        </div>

        <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
            <strong>Instructions:</strong> The parser may have split your contributions incorrectly.
            Use the checkboxes to select items to merge, then click "Merge Selected".
            Select exactly 5 contributions to use for your SciENcv entry.
        </div>

        <div id="contributions-list" class="space-y-3">
            {% for contrib in data.contributions %}
            <div class="contribution-item border rounded-lg p-4 hover:border-orange-300 transition-colors"
                 data-index="{{ loop.index0 }}">
                <div class="flex items-start gap-3">
                    <div class="flex flex-col items-center gap-1 pt-1">
                        <input type="checkbox"
                               class="contribution-checkbox w-5 h-5 text-orange-600 rounded"
                               data-index="{{ loop.index0 }}"
                               onchange="updateSelection()">
                        <button onclick="moveUp({{ loop.index0 }})"
                                class="text-gray-400 hover:text-gray-600 p-1" title="Move up">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                        </button>
                        <button onclick="moveDown({{ loop.index0 }})"
                                class="text-gray-400 hover:text-gray-600 p-1" title="Move down">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                {{ loop.index }}
                            </span>
                            <span class="text-xs text-gray-400">
                                {{ contrib.citations|length }} citation(s)
                            </span>
                            <button onclick="deleteContribution({{ loop.index0 }})"
                                    class="ml-auto text-red-400 hover:text-red-600 text-xs">
                                Delete
                            </button>
                        </div>
                        <p class="text-gray-700 text-sm contribution-narrative">{{ contrib.narrative }}</p>
                        {% if contrib.citations %}
                        <div class="mt-2 pl-4 border-l-2 border-gray-200">
                            <ul class="text-xs text-gray-500 space-y-1">
                                {% for citation in contrib.citations %}
                                <li class="truncate" title="{{ citation.text }}">
                                    {{ citation.text[:80] }}...
                                    {% if citation.pmid %}<span class="text-maroon-600">[PMID: {{ citation.pmid }}]</span>{% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-700">Selected Contributions for SciENcv:</p>
                    <p class="text-xs text-gray-500">NIH limits biosketches to 5 contributions</p>
                </div>
                <div id="selection-status" class="text-sm">
                    <span class="text-amber-600">Select 5 contributions to continue</span>
                </div>
            </div>
            <div id="selected-preview" class="mt-3 space-y-2">
                <!-- Selected items will appear here -->
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div class="text-sm text-gray-600">
                <p class="font-medium">Ready to create your SciENcv entry?</p>
                <p class="text-xs">A browser window will open. You'll need to log in to SciENcv manually.</p>
            </div>
            <div class="flex gap-4">
                <a href="{{ url_for('api.get_parsed_data', job_id=job_id) }}"
                   target="_blank"
                   class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    View JSON
                </a>
                <button onclick="saveAndContinue()"
                        id="continue-btn"
                        class="px-6 py-2 bg-maroon-700 text-white rounded-lg font-medium hover:bg-maroon-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Save & Start Automation
                </button>
            </div>
        </div>
        <div id="automation-status" class="mt-4 hidden">
            <div class="p-4 bg-maroon-50 rounded-lg">
                <p class="text-maroon-800" id="status-message">Starting automation...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Store data
    let contributions = {{ data.contributions | tojson | safe }};
    let personalStatement = {{ data.personal_statement | tojson | safe if data.personal_statement else '{}' }};
    let selectedIndices = new Set();
    let selectedRelatedProducts = new Set();
    let selectedOtherProducts = new Set();
    const jobId = '{{ job_id }}';

    // Restore previously selected items
    const savedSelectedContributions = {{ selected_contributions | tojson | safe if selected_contributions else '[]' }};
    {% if selected_products and selected_products is mapping %}
    const savedSelectedRelatedProducts = {{ selected_products.get('related', []) | tojson | safe }};
    const savedSelectedOtherProducts = {{ selected_products.get('other', []) | tojson | safe }};
    {% else %}
    const savedSelectedRelatedProducts = [];
    const savedSelectedOtherProducts = [];
    {% endif %}

    // Combine all citations from personal statement and contributions
    let allCitations = [];

    function buildAllCitations() {
        allCitations = [];
        // Add citations from personal statement
        if (personalStatement.citations) {
            personalStatement.citations.forEach((c, idx) => {
                allCitations.push({
                    ...c,
                    source: 'personal_statement',
                    sourceIndex: idx
                });
            });
        }
        // Add citations from contributions
        contributions.forEach((contrib, contribIdx) => {
            if (contrib.citations) {
                contrib.citations.forEach((c, citIdx) => {
                    allCitations.push({
                        ...c,
                        source: `contribution_${contribIdx}`,
                        sourceIndex: citIdx
                    });
                });
            }
        });
    }

    // ============ Products Selection Functions ============

    function renderProductsList(containerId, selectedSet, otherSet, checkboxClass) {
        const container = document.getElementById(containerId);
        container.innerHTML = allCitations.map((citation, idx) => {
            const isSelected = selectedSet.has(idx);
            const isInOther = otherSet.has(idx);
            const pmidBadge = citation.pmid ? `<span class="text-maroon-700 text-xs">[PMID: ${citation.pmid}]</span>` : '';
            const sourceLabel = citation.source === 'personal_statement'
                ? '<span class="text-green-600 text-xs">[Personal Statement]</span>'
                : `<span class="text-orange-600 text-xs">[Contribution ${parseInt(citation.source.split('_')[1]) + 1}]</span>`;

            return `
            <div class="product-item flex items-start gap-2 p-2 border rounded hover:border-teal-300 transition-colors ${isSelected ? 'border-teal-400 bg-teal-50' : ''} ${isInOther ? 'opacity-40' : ''}"
                 data-index="${idx}">
                <input type="checkbox"
                       class="${checkboxClass} w-4 h-4 mt-1 text-teal-600 rounded"
                       data-index="${idx}"
                       ${isSelected ? 'checked' : ''}
                       ${isInOther ? 'disabled' : ''}
                       onchange="updateProductSelections('${checkboxClass}')">
                <div class="flex-1">
                    <div class="text-sm text-gray-600">
                        ${escapeHtml(citation.text.substring(0, 120))}${citation.text.length > 120 ? '...' : ''}
                    </div>
                    <div class="flex gap-2 mt-1">
                        ${pmidBadge}
                        ${sourceLabel}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function updateProductSelections(checkboxClass) {
        if (checkboxClass === 'related-product-checkbox') {
            const checkboxes = document.querySelectorAll('.related-product-checkbox:checked');
            selectedRelatedProducts = new Set([...checkboxes].map(cb => parseInt(cb.dataset.index)));
            document.getElementById('related-products-count').textContent = selectedRelatedProducts.size;

            // Update styling
            if (selectedRelatedProducts.size > 5) {
                document.getElementById('related-products-count').classList.add('text-red-600', 'font-bold');
            } else {
                document.getElementById('related-products-count').classList.remove('text-red-600', 'font-bold');
            }
        } else {
            const checkboxes = document.querySelectorAll('.other-product-checkbox:checked');
            selectedOtherProducts = new Set([...checkboxes].map(cb => parseInt(cb.dataset.index)));
            document.getElementById('other-products-count').textContent = selectedOtherProducts.size;

            // Update styling
            if (selectedOtherProducts.size > 5) {
                document.getElementById('other-products-count').classList.add('text-red-600', 'font-bold');
            } else {
                document.getElementById('other-products-count').classList.remove('text-red-600', 'font-bold');
            }
        }

        // Re-render both lists to disable items selected in the other list
        renderProductsList('related-products-list', selectedRelatedProducts, selectedOtherProducts, 'related-product-checkbox');
        renderProductsList('other-products-list', selectedOtherProducts, selectedRelatedProducts, 'other-product-checkbox');
    }

    function restoreProductSelections() {
        if (savedSelectedRelatedProducts && savedSelectedRelatedProducts.length > 0) {
            selectedRelatedProducts = new Set(savedSelectedRelatedProducts);
        }
        if (savedSelectedOtherProducts && savedSelectedOtherProducts.length > 0) {
            selectedOtherProducts = new Set(savedSelectedOtherProducts);
        }
        renderProductsList('related-products-list', selectedRelatedProducts, selectedOtherProducts, 'related-product-checkbox');
        renderProductsList('other-products-list', selectedOtherProducts, selectedRelatedProducts, 'other-product-checkbox');
        document.getElementById('related-products-count').textContent = selectedRelatedProducts.size;
        document.getElementById('other-products-count').textContent = selectedOtherProducts.size;
    }

    // ============ Personal Statement Functions ============

    function editPersonalStatement() {
        document.getElementById('ps-display').classList.add('hidden');
        document.getElementById('ps-edit').classList.remove('hidden');
        document.getElementById('edit-ps-btn').classList.add('hidden');
    }

    function cancelPersonalStatementEdit() {
        document.getElementById('ps-display').classList.remove('hidden');
        document.getElementById('ps-edit').classList.add('hidden');
        document.getElementById('edit-ps-btn').classList.remove('hidden');
    }

    function savePersonalStatement() {
        // Get text
        personalStatement.text = document.getElementById('ps-text-input').value;

        // Get grants
        const grantRows = document.querySelectorAll('.grant-row');
        personalStatement.grants = [];
        grantRows.forEach(row => {
            personalStatement.grants.push({
                funder: row.querySelector('.grant-funder').value,
                number: row.querySelector('.grant-number').value,
                pi: row.querySelector('.grant-pi').value,
                role: row.querySelector('.grant-role').value,
                dates: row.querySelector('.grant-dates').value,
                title: row.querySelector('.grant-title').value
            });
        });

        // Update display
        updatePersonalStatementDisplay();
        cancelPersonalStatementEdit();
    }

    function updatePersonalStatementDisplay() {
        const display = document.getElementById('ps-display');
        let grantsHtml = '';
        if (personalStatement.grants && personalStatement.grants.length > 0) {
            grantsHtml = `
                <div class="mt-4">
                    <h3 class="font-medium text-gray-800 mb-2">Research Support (${personalStatement.grants.length})</h3>
                    <div class="space-y-3">
                        ${personalStatement.grants.map(g => `
                            <div class="text-sm border-l-2 border-green-200 pl-3">
                                <div class="flex flex-wrap gap-x-4 gap-y-1 text-gray-700">
                                    <span class="font-medium">${escapeHtml(g.funder)} ${escapeHtml(g.number)}</span>
                                    <span>${escapeHtml(g.pi)} (${escapeHtml(g.role)})</span>
                                    <span class="text-gray-500">${escapeHtml(g.dates)}</span>
                                </div>
                                <p class="text-gray-600 mt-1">${escapeHtml(g.title)}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        display.innerHTML = `
            <p class="text-gray-700 mb-4 whitespace-pre-wrap">${escapeHtml(personalStatement.text)}</p>
            ${grantsHtml}
        `;
    }

    function addGrant() {
        const container = document.getElementById('grants-editor');
        const index = container.children.length;
        const html = `
            <div class="grant-row border rounded-lg p-3 bg-gray-50" data-index="${index}">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                    <input type="text" placeholder="Funder (e.g., NIH)" class="grant-funder px-2 py-1 text-sm border rounded">
                    <input type="text" placeholder="Number" class="grant-number px-2 py-1 text-sm border rounded">
                    <input type="text" placeholder="PI" class="grant-pi px-2 py-1 text-sm border rounded">
                    <input type="text" placeholder="Role (PI, Co-I)" class="grant-role px-2 py-1 text-sm border rounded">
                    <input type="text" placeholder="Dates" class="grant-dates px-2 py-1 text-sm border rounded">
                    <button onclick="removeGrant(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                </div>
                <input type="text" placeholder="Grant Title" class="grant-title w-full px-2 py-1 text-sm border rounded">
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function removeGrant(btn) {
        btn.closest('.grant-row').remove();
    }

    // ============ Contribution Functions ============

    function updateSelection() {
        const checkboxes = document.querySelectorAll('.contribution-checkbox:checked');
        selectedIndices = new Set([...checkboxes].map(cb => parseInt(cb.dataset.index)));

        // Update count
        document.getElementById('selected-count').textContent = selectedIndices.size;

        // Update merge button
        const mergeBtn = document.getElementById('merge-btn');
        mergeBtn.disabled = selectedIndices.size < 2;

        // Update status
        const status = document.getElementById('selection-status');
        const continueBtn = document.getElementById('continue-btn');

        if (selectedIndices.size === 5) {
            status.innerHTML = '<span class="text-green-600">5 contributions selected - ready!</span>';
            continueBtn.disabled = false;
        } else if (selectedIndices.size > 5) {
            status.innerHTML = '<span class="text-red-600">Too many selected (max 5)</span>';
            continueBtn.disabled = true;
        } else {
            status.innerHTML = `<span class="text-amber-600">Select ${5 - selectedIndices.size} more contribution(s)</span>`;
            continueBtn.disabled = true;
        }

        // Update preview
        updatePreview();

        // Rebuild citations list since contributions may have changed
        buildAllCitations();
        restoreProductSelections();
    }

    function updatePreview() {
        const preview = document.getElementById('selected-preview');
        if (selectedIndices.size === 0) {
            preview.innerHTML = '<p class="text-gray-400 text-sm italic">No contributions selected</p>';
            return;
        }

        const items = [...selectedIndices].sort((a, b) => a - b).map((idx, i) => {
            const c = contributions[idx];
            const shortNarrative = c.narrative.substring(0, 100) + (c.narrative.length > 100 ? '...' : '');
            return `<div class="flex items-center gap-2 text-sm">
                <span class="w-5 h-5 bg-green-100 text-green-700 rounded-full flex items-center justify-center text-xs">${i + 1}</span>
                <span class="text-gray-600 truncate">${shortNarrative}</span>
            </div>`;
        });

        preview.innerHTML = items.join('');
    }

    function mergeSelected() {
        if (selectedIndices.size < 2) return;

        const indices = [...selectedIndices].sort((a, b) => a - b);
        const first = indices[0];

        // Combine narratives and citations
        let combinedNarrative = '';
        let combinedCitations = [];

        indices.forEach(idx => {
            const c = contributions[idx];
            if (combinedNarrative) combinedNarrative += '\n\n';
            combinedNarrative += c.narrative;
            combinedCitations = combinedCitations.concat(c.citations || []);
        });

        // Update first contribution
        contributions[first] = {
            narrative: combinedNarrative,
            citations: combinedCitations
        };

        // Remove other merged contributions (in reverse order to maintain indices)
        indices.slice(1).reverse().forEach(idx => {
            contributions.splice(idx, 1);
        });

        // Clear selection and re-render
        selectedIndices.clear();
        renderContributions();
        updateSelection();
    }

    function moveUp(index) {
        if (index === 0) return;
        [contributions[index - 1], contributions[index]] = [contributions[index], contributions[index - 1]];
        renderContributions();
    }

    function moveDown(index) {
        if (index >= contributions.length - 1) return;
        [contributions[index], contributions[index + 1]] = [contributions[index + 1], contributions[index]];
        renderContributions();
    }

    function deleteContribution(index) {
        if (!confirm('Delete this contribution?')) return;
        contributions.splice(index, 1);
        selectedIndices.delete(index);
        // Adjust indices for items after deleted one
        const newSelected = new Set();
        selectedIndices.forEach(i => {
            if (i < index) newSelected.add(i);
            else if (i > index) newSelected.add(i - 1);
        });
        selectedIndices = newSelected;
        renderContributions();
        updateSelection();
    }

    function renderContributions() {
        const container = document.getElementById('contributions-list');
        container.innerHTML = contributions.map((contrib, idx) => {
            const isChecked = selectedIndices.has(idx) ? 'checked' : '';
            const citationsHtml = (contrib.citations || []).map(c => {
                const pmidBadge = c.pmid ? `<span class="text-maroon-600">[PMID: ${c.pmid}]</span>` : '';
                return `<li class="truncate" title="${escapeHtml(c.text)}">${escapeHtml(c.text.substring(0, 80))}... ${pmidBadge}</li>`;
            }).join('');

            return `
            <div class="contribution-item border rounded-lg p-4 hover:border-orange-300 transition-colors" data-index="${idx}">
                <div class="flex items-start gap-3">
                    <div class="flex flex-col items-center gap-1 pt-1">
                        <input type="checkbox"
                               class="contribution-checkbox w-5 h-5 text-orange-600 rounded"
                               data-index="${idx}"
                               ${isChecked}
                               onchange="updateSelection()">
                        <button onclick="moveUp(${idx})" class="text-gray-400 hover:text-gray-600 p-1" title="Move up">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                        </button>
                        <button onclick="moveDown(${idx})" class="text-gray-400 hover:text-gray-600 p-1" title="Move down">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">${idx + 1}</span>
                            <span class="text-xs text-gray-400">${(contrib.citations || []).length} citation(s)</span>
                            <button onclick="editContribution(${idx})" class="ml-auto text-blue-400 hover:text-maroon-700 text-xs">Edit</button>
                            <button onclick="deleteContribution(${idx})" class="text-red-400 hover:text-red-600 text-xs">Delete</button>
                        </div>
                        <div id="narrative-display-${idx}">
                            <p class="text-gray-700 text-sm contribution-narrative whitespace-pre-wrap">${escapeHtml(contrib.narrative)}</p>
                        </div>
                        <div id="narrative-edit-${idx}" class="hidden">
                            <textarea id="narrative-textarea-${idx}"
                                      class="w-full p-2 text-sm border rounded-lg focus:ring-2 focus:ring-orange-300 focus:border-orange-300"
                                      rows="6">${escapeHtml(contrib.narrative)}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button onclick="saveEdit(${idx})" class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">Save</button>
                                <button onclick="cancelEdit(${idx})" class="px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                        ${citationsHtml ? `
                        <div class="mt-2 pl-4 border-l-2 border-gray-200">
                            <ul class="text-xs text-gray-500 space-y-1">${citationsHtml}</ul>
                        </div>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function editContribution(index) {
        document.getElementById(`narrative-display-${index}`).classList.add('hidden');
        document.getElementById(`narrative-edit-${index}`).classList.remove('hidden');
        const textarea = document.getElementById(`narrative-textarea-${index}`);
        textarea.focus();
        // Auto-resize textarea
        textarea.style.height = 'auto';
        textarea.style.height = Math.max(150, textarea.scrollHeight) + 'px';
    }

    function saveEdit(index) {
        const textarea = document.getElementById(`narrative-textarea-${index}`);
        contributions[index].narrative = textarea.value;
        renderContributions();
        updatePreview();
    }

    function cancelEdit(index) {
        document.getElementById(`narrative-display-${index}`).classList.remove('hidden');
        document.getElementById(`narrative-edit-${index}`).classList.add('hidden');
        // Reset textarea to original value
        document.getElementById(`narrative-textarea-${index}`).value = contributions[index].narrative;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function restoreContributionSelections() {
        if (savedSelectedContributions && savedSelectedContributions.length > 0) {
            savedSelectedContributions.forEach(idx => {
                const checkbox = document.querySelector(`.contribution-checkbox[data-index="${idx}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            updateSelection();
        }
    }

    async function saveAndContinue() {
        if (selectedIndices.size !== 5) {
            alert('Please select exactly 5 contributions');
            return;
        }

        if (selectedRelatedProducts.size > 5) {
            alert('Please select at most 5 products closely related to the proposed project');
            return;
        }

        if (selectedOtherProducts.size > 5) {
            alert('Please select at most 5 other significant products');
            return;
        }

        const selectedContributions = [...selectedIndices]
            .sort((a, b) => a - b)
            .map(idx => contributions[idx]);

        // Get selected products
        const relatedProducts = [...selectedRelatedProducts].map(idx => allCitations[idx]);
        const otherProducts = [...selectedOtherProducts].map(idx => allCitations[idx]);

        // Update the data on server (using authenticatedFetch from base.html)
        try {
            const response = await authenticatedFetch(`/api/parse/${jobId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contributions: selectedContributions,
                    personal_statement: personalStatement,
                    selected_contributions: [...selectedIndices],
                    selected_products: {
                        related: [...selectedRelatedProducts],
                        other: [...selectedOtherProducts]
                    },
                    products: {
                        related: relatedProducts,
                        other: otherProducts
                    }
                })
            });

            if (!response.ok) throw new Error('Failed to save');

            // Start automation
            startAutomation(jobId);
        } catch (error) {
            alert('Error saving changes: ' + error.message);
        }
    }

    async function startAutomation(jobId) {
        const statusDiv = document.getElementById('automation-status');
        const statusMsg = document.getElementById('status-message');
        statusDiv.classList.remove('hidden');
        statusMsg.textContent = 'Starting automation...';

        try {
            const response = await authenticatedFetch(`/api/automate/${jobId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();

            if (data.status === 'started') {
                statusMsg.textContent = data.message;
                statusDiv.className = 'mt-4 p-4 bg-green-50 rounded-lg';
                statusMsg.className = 'text-green-800';
            } else {
                statusMsg.textContent = data.error || 'Failed to start automation';
                statusDiv.className = 'mt-4 p-4 bg-red-50 rounded-lg';
                statusMsg.className = 'text-red-800';
            }
        } catch (error) {
            statusMsg.textContent = 'Error: ' + error.message;
            statusDiv.className = 'mt-4 p-4 bg-red-50 rounded-lg';
            statusMsg.className = 'text-red-800';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        buildAllCitations();
        updateSelection();
        restoreContributionSelections();
        restoreProductSelections();
    });
</script>
{% endblock %}
